<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Nobara RPG - Авторизация</title>
    <style>
        /* Основные стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: transparent; /* Как в спидометре */
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .blur-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
            z-index: 0;
        }
        
        .auth-container {
            position: relative;
            width: 380px;
            background: rgba(0, 0, 0, 0.5); /* Как в спидометре */
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
            overflow: hidden;
            animation: fadeIn 0.6s ease forwards;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, rgba(255,77,77,0.1), rgba(0,183,235,0.1), rgba(0,255,0,0.1)); /* Цвета спидометра */
            transform: rotate(45deg);
            z-index: -1;
            animation: gradientBG 15s ease infinite;
            background-size: 400% 400%;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #ff4d4d, #00b7eb, #00ff00); /* Цвета спидометра */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: gradientText 5s linear infinite;
        }
        
        .logo p {
            color: #bbb; /* Как второстепенный текст в спидометре */
            font-size: 14px;
            margin-top: 5px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group label {
            display: block;
            color: #bbb; /* Как в спидометре */
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .input-group input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff; /* Белый текст */
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: rgba(0, 183, 235, 0.5); /* Голубой из спидометра */
            background: rgba(0, 183, 235, 0.1);
            box-shadow: 0 0 0 3px rgba(0, 183, 235, 0.2);
        }
        
        .btn {
            padding: 14px;
            border-radius: 8px;
            border: none;
            background: #00b7eb; /* Голубой из спидометра */
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 183, 235, 0.3); /* Голубой из спидометра */
            background: #0097c7; /* Чуть темнее голубого */
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #bbb; /* Как второстепенный текст в спидометре */
        }
        
        .btn-secondary:hover {
            background: rgba(0, 183, 235, 0.1); /* Голубой из спидометра */
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            color: #fff;
        }
        
        .form-footer {
            text-align: center;
            margin-top: 20px;
            color: #bbb; /* Как в спидометре */
            font-size: 13px;
        }
        
        .form-footer a {
            color: #00b7eb; /* Голубой из спидометра */
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .form-footer a:hover {
            color: #0097c7; /* Чуть темнее голубого */
        }
        
        .error-message {
            color: #ff4d4d; /* Красный из спидометра */
            font-size: 13px;
            margin-top: 5px;
            text-align: center;
            opacity: 0;
            height: 0;
            transition: all 0.3s ease;
        }
        
        .error-message.show {
            opacity: 1;
            height: auto;
            margin-top: 10px;
        }

        /* Стили для полей ввода кода */
        .code-inputs {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .code-inputs input {
            width: 40px;
            height: 50px;
            text-align: center;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            transition: all 0.3s ease;
        }

        .code-inputs input:focus {
            outline: none;
            border-color: rgba(0, 183, 235, 0.5);
            background: rgba(0, 183, 235, 0.1);
            box-shadow: 0 0 0 3px rgba(0, 183, 235, 0.2);
        }
        
        /* Анимации */
        @keyframes gradientText {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.9); }
        }
        
        /* Адаптивность */
        @media (max-width: 480px) {
            .auth-container {
                width: 90%;
                padding: 30px 20px;
            }

            .code-inputs input {
                width: 35px;
                height: 45px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="blur-overlay"></div>
    
    <div class="auth-container" id="authContainer">
        <div class="logo">
            <h1>NOBARA RPG</h1>
            <p id="formTitle">Войдите в свой аккаунт</p>
        </div>
        
        <div id="loginForm" class="auth-form">
            <div class="input-group">
                <label>Имя пользователя</label>
                <input type="text" id="username" disabled="disabled" value="TestPlayer">
            </div>
            
            <div class="input-group">
                <label>Пароль</label>
                <input type="password" id="password" placeholder="Введите ваш пароль">
            </div>
            
            <div id="loginError" class="error-message"></div>
            
            <button class="btn" id="loginBtn">Войти</button>
            <button class="btn btn-secondary" id="showRegisterBtn">Создать аккаунт</button>
            
            <div class="form-footer">
                Забыли пароль? <a href="#" id="recoveryLink">Восстановить</a>
            </div>
        </div>
        
        <div id="registerForm" class="auth-form" style="display: none;">
            <div class="input-group">
                <label>Имя пользователя</label>
                <input type="text" id="regUsername" disabled="disabled" value="TestPlayer">
            </div>
            
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="Ваш email">
            </div>
            
            <div class="input-group">
                <label>Пароль</label>
                <input type="password" id="regPassword" placeholder="Не менее 6 символов">
            </div>
            
            <div class="input-group">
                <label>Подтвердите пароль</label>
                <input type="password" id="confirmPassword" placeholder="Повторите пароль">
            </div>
            
            <div id="registerError" class="error-message"></div>
            
            <button class="btn" id="registerBtn">Зарегистрироваться</button>
            <button class="btn btn-secondary" id="showLoginBtn">Уже есть аккаунт</button>
        </div>

        <div id="recoveryForm" class="auth-form" style="display: none;">
            <div id="emailStep">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="recoveryEmail" placeholder="Ваш email">
                </div>
                
                <div id="recoveryError" class="error-message"></div>
                
                <button class="btn" id="sendCodeBtn">Отправить код</button>
                <button class="btn btn-secondary" id="backToLoginBtn">Вернуться</button>
            </div>

            <div id="codeStep" style="display: none;">
                <div class="input-group">
                    <label>Введите 6-значный код</label>
                    <div class="code-inputs">
                        <input type="text" maxlength="1" class="code-input" id="code1">
                        <input type="text" maxlength="1" class="code-input" id="code2">
                        <input type="text" maxlength="1" class="code-input" id="code3">
                        <input type="text" maxlength="1" class="code-input" id="code4">
                        <input type="text" maxlength="1" class="code-input" id="code5">
                        <input type="text" maxlength="1" class="code-input" id="code6">
                    </div>
                </div>
                
                <div id="codeError" class="error-message"></div>
                
                <button class="btn" id="verifyCodeBtn">Подтвердить код</button>
                <button class="btn btn-secondary" id="backToEmailBtn">Назад</button>
            </div>

            <div id="newPasswordStep" style="display: none;">
                <div class="input-group">
                    <label>Введите новый пароль</label>
                    <input type="password" id="newPassword" placeholder="Не менее 6 символов">
                </div>
                
                <div class="input-group">
                    <label>Повторите пароль</label>
                    <input type="password" id="confirmNewPassword" placeholder="Повторите пароль">
                </div>
                
                <div id="newPasswordError" class="error-message"></div>
                
                <button class="btn" id="changePasswordBtn">Сменить пароль</button>
                <button class="btn btn-secondary" id="backToCodeBtn">Назад</button>
            </div>
        </div>
    </div>

   <script>
// Глобальная переменная для хранения ника
let playerName = '';

// Отладочная функция
function debug(msg) {
    if (typeof cef !== 'undefined') cef.emit('debug_message', msg);
    else console.log('[DEBUG]', msg);
}

// При загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    initPlayerName();
    setupFormEvents();
    setupCefListeners();
});

// Запрашиваем имя у CEF или задаём тестовое
function initPlayerName() {
    if (typeof cef !== 'undefined') {
        cef.on('set_name', (name) => {
            if (name && name.trim() !== '') {
                playerName = name.trim();
                updateUsernameFields(playerName);
                debug('Ник получен: ' + playerName);
            }
        });
        cef.emit('get_name');
        debug('Запрос ника отправлен');
    } else {
        playerName = 'TestPlayer';
        updateUsernameFields(playerName);
        debug('CEF не найден, имя по умолчанию');
    }
}

// Устанавливаем ник в поля
function updateUsernameFields(name) {
    document.querySelectorAll('input[id="username"], input[id="regUsername"]').forEach(el => {
        el.value = name;
        el.placeholder = name;
    });
}

// Подписки на CEF-события
function setupCefListeners() {
    if (typeof cef === 'undefined') return;

    cef.on('account_status', (status) => {
        debug('Получен account_status: ' + status);

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        if (status === 'registered') {
            switchForm(registerForm, loginForm);
            document.getElementById('formTitle').textContent = 'Войдите в свой аккаунт';
        } else if (status === 'not_registered') {
            switchForm(loginForm, registerForm);
            document.getElementById('formTitle').textContent = 'Создайте аккаунт';
        }
    });

    cef.on('auth_success', () => {
        debug('Успешная авторизация');
        closeInterface();
    });

    cef.on('auth_error', (msg) => {
        debug('Ошибка авторизации: ' + msg);
        showError('login', msg);
    });

    cef.on('register_success', () => {
        debug('Успешная регистрация');
        showError('login', 'Регистрация успешна! Теперь войдите');
        switchForm(document.getElementById('registerForm'), document.getElementById('loginForm'));
        document.getElementById('formTitle').textContent = 'Войдите в свой аккаунт';
    });

    cef.on('register_error', (msg) => {
        debug('Ошибка регистрации: ' + msg);
        showError('register', msg);
    });

    cef.on('recovery_success', (msg) => {
        debug('Успешное восстановление: ' + msg);
        showError('recovery', msg);
        setTimeout(() => {
            switchForm(document.getElementById('recoveryForm'), document.getElementById('loginForm'));
            document.getElementById('formTitle').textContent = 'Войдите в свой аккаунт';
        }, 3000);
    });

    cef.on('recovery_error', (msg) => {
        debug('Ошибка восстановления: ' + msg);
        showError('recovery', msg);
    });
}

// Назначение обработчиков кнопок и полей
function setupFormEvents() {
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('registerBtn').addEventListener('click', register);
    document.getElementById('sendRecoveryBtn').addEventListener('click', sendRecovery);

    document.getElementById('showRegisterBtn').addEventListener('click', () => {
        switchForm(document.getElementById('loginForm'), document.getElementById('registerForm'));
        document.getElementById('formTitle').textContent = 'Создайте аккаунт';
    });

    document.getElementById('showLoginBtn').addEventListener('click', () => {
        switchForm(document.getElementById('registerForm'), document.getElementById('loginForm'));
        document.getElementById('formTitle').textContent = 'Войдите в свой аккаунт';
    });

    document.getElementById('recoveryLink').addEventListener('click', () => {
        switchForm(document.getElementById('loginForm'), document.getElementById('recoveryForm'));
        document.getElementById('formTitle').textContent = 'Восстановление пароля';
    });

    document.getElementById('backToLoginBtn').addEventListener('click', () => {
        switchForm(document.getElementById('recoveryForm'), document.getElementById('loginForm'));
        document.getElementById('formTitle').textContent = 'Войдите в свой аккаунт';
    });

    // Enter key
    document.getElementById('password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
    });

    document.getElementById('confirmPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') register();
    });

    document.getElementById('recoveryEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendRecovery();
    });
}

// Плавное переключение форм
function switchForm(from, to) {
    from.style.opacity = '0';
    from.style.transform = 'translateX(-30px)';

    setTimeout(() => {
        from.style.display = 'none';
        to.style.display = 'flex';

        setTimeout(() => {
            to.style.opacity = '1';
            to.style.transform = 'translateX(0)';
        }, 50);
    }, 300);
}

// Показ ошибки
function showError(type, msg) {
    const el = document.getElementById(`${type}Error`);
    if (!el) return;

    el.textContent = msg;
    el.classList.add('show');

    setTimeout(() => el.classList.remove('show'), 5000);
}

// Авторизация
function login() {
    const password = document.getElementById('password').value.trim();

    if (!password || password.length < 8 || /\s/.test(password)) {
        return showError('login', 'Пароль должен быть не менее 8 символов и без пробелов');
    }

    if (typeof cef !== 'undefined') {
        cef.emit('auth_login', password);
        debug('Отправлен auth_login');
    }
}

// Регистрация
function register() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const confirm = document.getElementById('confirmPassword').value.trim();

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        return showError('register', 'Введите корректный email');
    }

    if (password.length < 8 || /\s/.test(password)) {
        return showError('register', 'Пароль должен быть не менее 8 символов и без пробелов');
    }

    if (password !== confirm) {
        return showError('register', 'Пароли не совпадают');
    }

    const data = `${email}|${password}`;
    if (typeof cef !== 'undefined') {
        cef.emit('auth_register', data);
        debug('Отправлен auth_register');
    }
}

// Восстановление пароля
function sendRecovery() {
    const email = document.getElementById('recoveryEmail').value.trim();

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        return showError('recovery', 'Введите корректный email');
    }

    if (typeof cef !== 'undefined') {
        cef.emit('auth_recovery', email);
        debug('Отправлен auth_recovery');
    }
}

// Закрытие интерфейса
function closeInterface() {
    const container = document.getElementById('authContainer');
    container.style.animation = 'fadeOut 0.5s forwards';
    setTimeout(() => {
        if (typeof cef !== 'undefined') {
            cef.emit('ExitCef', '');
        }
    }, 500);
}
</script>

</body>
</html>
